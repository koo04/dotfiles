#!/bin/bash

set -e  # Exit on any error

# Colors and formatting
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)"
PROGRAMS_FILE="$SCRIPT_DIR/programs.txt"

# Logging function
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Check if running as root
if [[ $EUID -eq 0 ]]; then
   error "This script should not be run as root"
   exit 1
fi

# Initial system update
log "Updating system packages..."
sudo apt-get update

# Install essential packages first
log "Installing essential packages..."
sudo apt-get install -y wget git curl ca-certificates build-essential

# Install Go (needed for gum)
install_go() {
    if command -v go &> /dev/null; then
        log "Go is already installed"
        return
    fi
    
    log "Installing Go..."
    GO_VERSION="1.23.2"
    wget "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" -O /tmp/go.tar.gz
    sudo rm -rf /usr/local/go
    sudo tar -C /usr/local -xzf /tmp/go.tar.gz
    
    # Add Go to PATH if not already there
    if ! grep -q "/usr/local/go/bin" ~/.bashrc; then
        echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin' >> ~/.bashrc
    fi
    
    export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
    rm /tmp/go.tar.gz
}

# Install gum for better UI
install_gum() {
    if command -v gum &> /dev/null; then
        log "Gum is already installed"
        return
    fi
    
    log "Installing gum..."
    go install github.com/charmbracelet/gum@latest
}

# Function to install programs based on method
install_program() {
    local program="$1"
    local method="$2"
    local description="$3"
    
    case $method in
        "apt")
            if dpkg -l | grep -q "^ii  $program "; then
                log "$program is already installed"
            else
                log "Installing $program via apt..."
                sudo apt-get install -y "$program"
            fi
            ;;
        "snap")
            if snap list | grep -q "$program"; then
                log "$program is already installed"
            else
                log "Installing $program via snap..."
                sudo snap install "$program"
            fi
            ;;
        "manual")
            install_manual_program "$program"
            ;;
        "curl")
            install_curl_program "$program"
            ;;
        "go")
            log "Installing $program via go..."
            go install "$program"
            ;;
        *)
            warning "Unknown installation method: $method for $program"
            ;;
    esac
}

# Install programs that require manual installation
install_manual_program() {
    local program="$1"
    
    case $program in
        "github-cli")
            install_github_cli
            ;;
        "docker")
            install_docker
            ;;
        "neovim")
            install_neovim
            ;;
        *)
            warning "Manual installation not defined for: $program"
            ;;
    esac
}

# Install programs via curl
install_curl_program() {
    local program="$1"
    
    case $program in
        "teleport")
            install_teleport
            ;;
        "k9s")
            install_k9s
            ;;
        *)
            warning "Curl installation not defined for: $program"
            ;;
    esac
}

# GitHub CLI installation and SSH setup
install_github_cli() {
    if command -v gh &> /dev/null; then
        log "GitHub CLI is already installed"
    else
        log "Installing GitHub CLI..."
        
        # Add GitHub CLI repository
        type -p curl >/dev/null || { sudo apt update && sudo apt install curl -y; }
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
        
        log "GitHub CLI installed successfully"
    fi
    
    # Setup SSH key and GitHub authentication
    setup_github_ssh
}

# Setup GitHub SSH key and authentication
setup_github_ssh() {
    echo ""
    if ! gum confirm "Would you like to set up GitHub authentication and SSH key?"; then
        log "Skipping GitHub setup"
        return
    fi
    
    # Check if SSH key already exists
    if [[ -f "$HOME/.ssh/id_rsa" || -f "$HOME/.ssh/id_ed25519" ]]; then
        log "SSH key already exists"
        if ! gum confirm "Would you like to use the existing SSH key?"; then
            generate_new_ssh_key
        else
            log "Using existing SSH key"
            # Add existing key to SSH agent
            eval "$(ssh-agent -s)"
            if [[ -f "$HOME/.ssh/id_rsa" ]]; then
                ssh-add "$HOME/.ssh/id_rsa"
            elif [[ -f "$HOME/.ssh/id_ed25519" ]]; then
                ssh-add "$HOME/.ssh/id_ed25519"
            fi
        fi
    else
        generate_new_ssh_key
    fi
    
    # Authenticate with GitHub
    echo ""
    log "Authenticating with GitHub..."
    if gum confirm "Open browser to authenticate with GitHub?"; then
        gh auth login --web --git-protocol ssh
    else
        log "You can authenticate later with: gh auth login"
    fi
    
    # Add SSH key to GitHub if not already added
    if gh auth status &>/dev/null; then
        echo ""
        if gum confirm "Add SSH key to your GitHub account?"; then
            add_ssh_key_to_github
        fi
    else
        log "GitHub authentication required to add SSH key automatically"
        log "You can add it later with: gh ssh-key add ~/.ssh/id_ed25519.pub"
    fi
}

# Generate new SSH key
generate_new_ssh_key() {
    echo ""
    email=$(gum input --placeholder "Enter your email for SSH key" --value "$(git config --global user.email 2>/dev/null || echo '')")
    
    if [[ -z "$email" ]]; then
        error "Email is required for SSH key generation"
        return 1
    fi
    
    log "Generating new RSA SSH key..."
    ssh-keygen -t rsa -b 4096 -C "$email" -f "$HOME/.ssh/id_rsa" -N ""
    
    # Start SSH agent and add key
    eval "$(ssh-agent -s)"
    ssh-add "$HOME/.ssh/id_rsa"
    
    log "RSA SSH key generated and added to agent"
}

# Add SSH key to GitHub account
add_ssh_key_to_github() {
    local ssh_key_file
    
    # Determine which SSH key to use (prefer RSA since that's what we generate)
    if [[ -f "$HOME/.ssh/id_rsa.pub" ]]; then
        ssh_key_file="$HOME/.ssh/id_rsa.pub"
    elif [[ -f "$HOME/.ssh/id_ed25519.pub" ]]; then
        ssh_key_file="$HOME/.ssh/id_ed25519.pub"
    else
        error "No SSH public key found"
        return 1
    fi
    
    # Get a title for the SSH key
    hostname=$(hostname)
    key_title=$(gum input --placeholder "Enter a title for this SSH key" --value "$(whoami)@$hostname")
    
    # Add the key to GitHub
    if gh ssh-key add "$ssh_key_file" --title "$key_title"; then
        log "SSH key successfully added to GitHub account"
        
        # Test the connection
        echo ""
        log "Testing SSH connection to GitHub..."
        if ssh -T git@github.com -o StrictHostKeyChecking=no 2>&1 | grep -q "successfully authenticated"; then
            log "SSH connection to GitHub successful!"
        else
            warning "SSH connection test failed. You may need to accept GitHub's host key manually."
        fi
    else
        error "Failed to add SSH key to GitHub"
    fi
}

# Docker installation
install_docker() {
    if command -v docker &> /dev/null; then
        log "Docker is already installed"
        return
    fi
    
    log "Installing Docker..."
    
    # Add Docker's official GPG key
    sudo install -m 0755 -d /etc/apt/keyrings
    sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
    sudo chmod a+r /etc/apt/keyrings/docker.asc
    
    # Add the repository to Apt sources
    echo \
      "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
      $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
      sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    sudo apt-get update
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
    
    # Add user to docker group
    sudo usermod -aG docker $USER
    log "Added $USER to docker group. You may need to log out and back in for this to take effect."
}

# Neovim installation
install_neovim() {
    if [[ -f /opt/nvim-linux64/bin/nvim ]]; then
        log "Neovim is already installed"
        return
    fi
    
    log "Installing Neovim..."
    curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz
    sudo rm -rf /opt/nvim-linux64
    sudo tar -C /opt -xzf nvim-linux-x86_64.tar.gz
    rm nvim-linux-x86_64.tar.gz

    # Create symlink in /usr/local/bin
    sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
}

# Teleport installation
install_teleport() {
    if command -v tsh &> /dev/null; then
        log "Teleport is already installed"
        return
    fi
    
    log "Installing Teleport..."
    curl https://goteleport.com/static/install.sh | bash -s 16.4.0
}

# K9s installation
install_k9s() {
    if command -v k9s &> /dev/null; then
        log "k9s is already installed"
        return
    fi
    
    log "Installing k9s..."
    K9S_VERSION=$(curl -s https://api.github.com/repos/derailed/k9s/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    curl -sL "https://github.com/derailed/k9s/releases/download/${K9S_VERSION}/k9s_Linux_amd64.tar.gz" | sudo tar xz -C /usr/local/bin k9s
}

# Create symbolic links
create_symlinks() {
    log "Creating symbolic links..."
    
    # Create .config directory if it doesn't exist
    mkdir -p "$HOME/.config"
    
    # Neovim config
    if [[ -L "$HOME/.config/nvim" ]]; then
        log "Neovim config symlink already exists"
    else
        ln -sf "$SCRIPT_DIR/nvim" "$HOME/.config/nvim"
        log "Created symlink: ~/.config/nvim -> $SCRIPT_DIR/nvim"
    fi
    
    # Tmux config
    if [[ -L "$HOME/.tmux.conf" ]]; then
        log "Tmux config symlink already exists"
    else
        ln -sf "$SCRIPT_DIR/tmux/tmux.conf" "$HOME/.tmux.conf"
        log "Created symlink: ~/.tmux.conf -> $SCRIPT_DIR/tmux/tmux.conf"
    fi
    
    # Git global gitignore
    if [[ -L "$HOME/.gitignore" ]]; then
        log "Git global gitignore symlink already exists"
    else
        ln -sf "$SCRIPT_DIR/git/global_gitignore" "$HOME/.gitignore"
        log "Created symlink: ~/.gitignore -> $SCRIPT_DIR/git/global_gitignore"
    fi
}

# Configure git
configure_git() {
    log "Configuring Git..."
    
    # Get current git config values as defaults
    current_name=$(git config --global user.name 2>/dev/null || echo "")
    current_email=$(git config --global user.email 2>/dev/null || echo "")
    
    # Ask for user name
    echo ""
    if [[ -n "$current_name" ]]; then
        user_name=$(gum input --placeholder "Enter your Git user name" --value "$current_name")
    else
        user_name=$(gum input --placeholder "Enter your Git user name (e.g., John Doe)")
    fi
    
    # Ask for user email
    if [[ -n "$current_email" ]]; then
        user_email=$(gum input --placeholder "Enter your Git email" --value "$current_email")
    else
        user_email=$(gum input --placeholder "Enter your Git email (e.g., john@example.com)")
    fi
    
    # Set git configuration
    git config --global core.excludesfile ~/.gitignore
    git config --global user.name "$user_name"
    git config --global user.email "$user_email"
    git config --global url.ssh://git@github.com/.insteadof https://github.com/
    git config --global remote.origin.prune true
    
    log "Git configured with name: $user_name and email: $user_email"
}

# Main installation function
main() {
    log "Starting dotfiles installation..."
    
    # Install Go and gum first
    install_go
    install_gum
    
    # Install and setup GitHub CLI early for SSH key management
    echo ""
    if gum confirm "Would you like to install and setup GitHub CLI with SSH keys?"; then
        install_github_cli
    else
        log "Skipping GitHub CLI setup"
    fi
    
    # Ask about system upgrade
    echo ""
    if gum confirm "Would you like to upgrade system packages (apt upgrade)?"; then
        log "Upgrading system packages..."
        sudo apt-get upgrade -y
    else
        log "Skipping system upgrade"
    fi
    
    # Check if programs file exists
    if [[ ! -f "$PROGRAMS_FILE" ]]; then
        error "Programs file not found: $PROGRAMS_FILE"
        exit 1
    fi
    
    # Read programs and let user select which to install
    echo ""
    log "Reading programs list from $PROGRAMS_FILE"
    
    # Create arrays for gum selection
    programs=()
    methods=()
    descriptions=()
    
    while IFS=':' read -r program method description; do
        # Skip comments and empty lines
        [[ $program =~ ^#.*$ ]] || [[ -z $program ]] && continue
        programs+=("$program")
        methods+=("$method")
        descriptions+=("$description")
    done < "$PROGRAMS_FILE"
    
    # Let user select programs to install
    echo ""
    log "Select programs to install:"
    selected_programs=$(printf '%s\n' "${programs[@]}" | gum choose --no-limit)
    
    if [[ -z "$selected_programs" ]]; then
        log "No programs selected for installation"
    else
        echo ""
        log "Installing selected programs..."
        
        # Convert selected_programs to array
        IFS=$'\n' read -d '' -r -a selected_array <<< "$selected_programs" || true
        
        # Install each selected program
        for selected in "${selected_array[@]}"; do
            # Find the method and description for this program
            for i in "${!programs[@]}"; do
                if [[ "${programs[$i]}" == "$selected" ]]; then
                    echo ""
                    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                    log "Installing $selected (${descriptions[$i]})"
                    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                    
                    set +e  # Temporarily disable exit on error
                    if install_program "$selected" "${methods[$i]}" "${descriptions[$i]}"; then
                        echo -e "${GREEN}✓${NC} Successfully installed $selected"
                    else
                        echo -e "${RED}✗${NC} Failed to install $selected"
                    fi
                    set -e  # Re-enable exit on error
                    break
                fi
            done
        done
    fi

    # Create symbolic links
    echo ""
    if gum confirm "Create symbolic links for dotfiles?"; then
        create_symlinks
    fi

    # Configure git
    echo ""
    if gum confirm "Configure Git with your settings?"; then
        configure_git
    fi
    
    echo ""
    log "Installation completed!"
    log "Please restart your terminal or run 'source ~/.bashrc' to update your PATH"
    
    # Show final summary
    gum style --border normal --margin "1" --padding "1 2" --border-foreground 212 \
        "Installation Summary" \
        "" \
        "✓ Selected programs installed" \
        "✓ Symbolic links created (if selected)" \
        "✓ Git configured (if selected)" \
        "" \
        "Note: If Docker was installed, you may need to log out and back in" \
        "for group permissions to take effect."
}

# Run main function
main "$@"
